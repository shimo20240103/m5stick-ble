<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>M5StickC 足組み判定</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
}
button {
  margin: 5px;
  padding: 10px 20px;
  font-size: 16px;
}
#guessDisplay {
  font-size: 48px;
  font-weight: bold;
  margin-top: 20px;
  color: red;
}
</style>
</head>

<body>

<h2>M5StickC 足組み判定</h2>

<button onclick="calibrate()">キャリブレーション</button>
<br>
<button onclick="declareRight()">右 宣言</button>
<button onclick="declareLeft()">左 宣言</button>
<br>
<button onclick="startRepeat()">5秒組む↔5秒N ×10</button>

<div id="guessDisplay">判定: N</div>

<script>
/* =====================
   初期値・変数
===================== */

// 初期Pitch / Roll
let R_init = { pitch: 0, roll: 0 };
let L_init = { pitch: 0, roll: 0 };

// 現在値（BLEで更新される想定）
let R_now = { pitch: 0, roll: 0 };
let L_now = { pitch: 0, roll: 0 };

// 判定結果
let guess = "N";

// 閾値
const TH_45 = 20;
const TH_90 = 40;

/* =====================
   キャリブレーション
===================== */
function calibrate() {
  R_init.pitch = R_now.pitch;
  R_init.roll  = R_now.roll;
  L_init.pitch = L_now.pitch;
  L_init.roll  = L_now.roll;
  alert("キャリブレーション完了");
}

/* =====================
   判定処理（常時実行）
===================== */
function judge() {

  // 差分
  let dRp = R_now.pitch - R_init.pitch;
  let dRr = R_now.roll  - R_init.roll;
  let dLp = L_now.pitch - L_init.pitch;
  let dLr = L_now.roll  - L_init.roll;

  // ベクトル大きさ
  let Rvec = Math.sqrt(dRp*dRp + dRr*dRr);
  let Lvec = Math.sqrt(dLp*dLp + dLr*dLr);

  guess = "N";

  // 右判定
  if (Rvec > TH_90) {
    guess = "R90";
  } else if (Rvec > TH_45) {
    guess = "R45";
  }

  // 左判定（右より優先しない）
  if (Lvec > TH_90) {
    guess = "L90";
  } else if (Lvec > TH_45 && guess === "N") {
    guess = "L45";
  }

  document.getElementById("guessDisplay").textContent = "判定: " + guess;
}

/* =====================
   宣言ボタン（ログ用途）
===================== */
function declareRight() {
  console.log("右 宣言");
}
function declareLeft() {
  console.log("左 宣言");
}

/* =====================
   5秒組む↔5秒N ×10
===================== */
let repeatCount = 0;
let repeatState = false;

function startRepeat() {
  repeatCount = 0;
  repeatState = true;
  repeatLoop();
}

function repeatLoop() {
  if (repeatCount >= 10) {
    repeatState = false;
    return;
  }

  console.log("組む");
  setTimeout(() => {
    console.log("N");
    repeatCount++;
    if (repeatState) {
      setTimeout(repeatLoop, 5000);
    }
  }, 5000);
}

/* =====================
   ダミーIMU更新（実機ではBLE）
===================== */
setInterval(() => {
  // テスト用ダミー値
  R_now.pitch = Math.random()*50;
  R_now.roll  = Math.random()*50;
  L_now.pitch = Math.random()*50;
  L_now.roll  = Math.random()*50;

  judge();
}, 200);

</script>

</body>
</html>
