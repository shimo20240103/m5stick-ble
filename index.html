<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>M5StickC 足組みデータ取得（実験用）</title>
<style>
body { font-family: 'Arial', sans-serif; background:#eaf7f3; color:#004d40; text-align:center; margin:0; padding:0; }
h1 { background:#a7ffeb; margin:0; padding:18px 0; border-bottom-left-radius:14px; border-bottom-right-radius:14px; }
.controls { margin:12px 0; }
button { font-size:15px; padding:8px 16px; margin:6px; border-radius:8px; border:none; background:#26a69a; color:#fff; cursor:pointer;}
#status1,#status2 { margin-top:10px; font-weight:bold; font-size:18px; display:block; }
pre { display:inline-block; background:#b2dfdb; padding:8px 14px; border-radius:10px; margin-top:10px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<h1>M5StickC 足組みデータ取得（実験用）</h1>

<div class="controls">
  <button id="connectBtn1" onclick="connect(1)">右足 接続</button>
  <button id="connectBtn2" onclick="connect(2)">左足 接続</button>
  <button onclick="downloadExcel()">Excelダウンロード</button>
</div>

<div id="status1">右足: 未接続</div>
<pre id="values1">Pitch:0.00 Roll:0.00</pre>

<div id="status2">左足: 未接続</div>
<pre id="values2">Pitch:0.00 Roll:0.00</pre>

<script>
/* BLE UUID */
const serviceUUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const charUUID = "beb5483e-36e1-4688-b7f5-ea073f74076a";

/* 最新 pitch/roll */
let latestRight = [0,0];
let latestLeft = [0,0];

/* Excel用データ */
let accelData = [["Time","Right_P","Right_R","Left_P","Left_R"]];

async function connect(id){
    const btn = document.getElementById("connectBtn"+id);
    btn.disabled = true;
    try{
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices:true,
            optionalServices:[serviceUUID]
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(serviceUUID);
        const char = await service.getCharacteristic(charUUID);
        await char.startNotifications();
        char.addEventListener("characteristicvaluechanged", e=>{
            const value = new TextDecoder().decode(e.target.value).trim();
            const parts = value.split(",");
            if(parts.length >= 2){
                const pitch = parseFloat(parts[0]);
                const roll = parseFloat(parts[1]);
                if(id === 1){
                    latestRight = [pitch, roll];
                    document.getElementById("values1").textContent = `Pitch:${pitch.toFixed(2)} Roll:${roll.toFixed(2)}`;
                }else{
                    latestLeft = [pitch, roll];
                    document.getElementById("values2").textContent = `Pitch:${pitch.toFixed(2)} Roll:${roll.toFixed(2)}`;
                }
                // Excel用に記録
                accelData.push([
                    new Date().toLocaleTimeString(),
                    latestRight[0], latestRight[1],
                    latestLeft[0], latestLeft[1]
                ]);
            }
        });
        document.getElementById("status"+id).textContent = `${id===1?"右":"左"}足 接続完了`;
    }catch(e){
        alert("接続失敗: "+e);
        btn.disabled = false;
    }
}

/* Excel出力 */
function downloadExcel(){
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(accelData);
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, "foot_data.xlsx");
}
</script>

</body>
</html>
