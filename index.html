<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"><!-- 日本語文字化け防止 -->
<title>M5StickC 足組みデータ取得（実験用１）</title>

<style>
/* ===== ページ全体の見た目 ===== */
body {
  font-family:'Arial', sans-serif;
  background:#eaf7f3; /* 通常背景 */
  color:#004d40;
  text-align:center;
  margin:0;
  padding:0;
}

/* タイトル */
h1 {
  background:#a7ffeb;
  margin:0;
  padding:18px 0;
  border-radius:0 0 14px 14px;
}

/* ボタンエリア */
.controls { margin:12px 0; }

/* ボタンデザイン */
button {
  font-size:15px;
  padding:8px 16px;
  margin:6px;
  border-radius:8px;
  border:none;
  background:#26a69a;
  color:#fff;
  cursor:pointer;
}

/* 接続状態表示 */
#status1,#status2 { font-weight:bold; }

/* Pitch Roll表示 */
pre {
  display:inline-block;
  background:#b2dfdb;
  padding:8px 14px;
  border-radius:10px;
}

/* 判定表示 */
#guessDisplay {
  font-size:48px;
  font-weight:bold;
  margin-top:20px;
  color:#d32f2f;
}

/* 宣言表示 */
#declareDisplay {
  font-size:22px;
  font-weight:bold;
  margin-top:10px;
}

/* カウントダウン表示 */
#countdownDisplay {
  font-size:36px;
  font-weight:bold;
  margin-top:10px;
}
</style>

<!-- Excel出力用ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body>

<h1>M5StickC 足組みデータ取得（実験用）</h1>

<div class="controls">
  <!-- BLE接続 -->
  <button onclick="connect(1)">右足 接続</button>
  <button onclick="connect(2)">左足 接続</button>

  <!-- 基準姿勢保存 -->
  <button onclick="calibrate()">キャリブレーション</button>

  <!-- Excel保存 -->
  <button onclick="downloadExcel()">Excel</button>
</div>

<div class="controls">
  <!-- 手動宣言 -->
  <button onclick="toggleDeclare('R')">右 宣言</button>
  <button onclick="toggleDeclare('L')">左 宣言</button>
</div>

<div class="controls">
  <!-- 実験自動シーケンス -->
  <button onclick="runRepeat()">N5秒 → 組む10秒 ×10回</button>
</div>

<!-- ===== 表示UI ===== -->
<div id="status1">右足: 未接続</div>
<pre id="values1">Pitch:0.00 Roll:0.00</pre>

<div id="status2">左足: 未接続</div>
<pre id="values2">Pitch:0.00 Roll:0.00</pre>

<div id="guessDisplay">判定: N</div>
<div id="declareDisplay">宣言: なし</div>
<div id="countdownDisplay"></div>

<script>

/* ===== BLE UUID（ESP32側と一致）===== */
const serviceUUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const charUUID    = "beb5483e-36e1-4688-b7f5-ea073f74076a";

/* ===== 状態変数 ===== */
let latestRight=[0,0], latestLeft=[0,0]; // 最新Pitch Roll
let baseRight=null, baseLeft=null;       // キャリブレーション基準
let declaration="none";                  // 手動宣言

/* ===== Excel保存用 ===== */
let accelData=[[
  "Time",
  "Right_P","Right_R","Rvec","Rjudge",
  "Left_P","Left_R","Lvec","Ljudge",
  "Declaration",
  "Guess"
]];

/* ===== 判定関数 ===== */
function judge(vec, side){
  /* cos式に変更したので閾値は小さめ想定 */
  if(vec > 30) return side+"90"; // 深い足組み
  if(vec > 5)  return side+"45"; // 浅い足組み
  return side+"N";                // 通常
}

/* ===== 宣言切替 ===== */
function toggleDeclare(side){
  declaration = (declaration===side)?"none":side;
  declareDisplay.textContent =
    "宣言: "+(declaration==="none"?"なし":declaration);
}

/* ===== BLE接続 ===== */
async function connect(id){

  const device = await navigator.bluetooth.requestDevice({
    acceptAllDevices:true,
    optionalServices:[serviceUUID]
  });

  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(serviceUUID);
  const char = await service.getCharacteristic(charUUID);

  await char.startNotifications();

  /* ===== データ受信 ===== */
  char.addEventListener("characteristicvaluechanged",e=>{

    /* 文字列 → 数値変換 */
    const [p,r] = new TextDecoder().decode(e.target.value)
                     .trim().split(",").map(Number);

    if(isNaN(p)||isNaN(r)) return;

    /* 最新値更新 */
    if(id===1){
      latestRight=[p,r];
      values1.textContent=`Pitch:${p.toFixed(2)} Roll:${r.toFixed(2)}`;
    }else{
      latestLeft=[p,r];
      values2.textContent=`Pitch:${p.toFixed(2)} Roll:${r.toFixed(2)}`;
    }

    /* ===== 基準との差分 ===== */
    const dR=baseRight?[latestRight[0]-baseRight[0],latestRight[1]-baseRight[1]]:[0,0];
    const dL=baseLeft ?[latestLeft[0]-baseLeft[0], latestLeft[1]-baseLeft[1]]:[0,0];

    /* ===== vec計算（研究式）=====
       vec = {1 - cos(pitch)*cos(roll)} * 100
       ※Math.cosはラジアンなのでdeg→rad変換必要
    */

    /* Right */
    const pR_rad = dR[0] * Math.PI / 180;
    const rR_rad = dR[1] * Math.PI / 180;

    /* Left */
    const pL_rad = dL[0] * Math.PI / 180;
    const rL_rad = dL[1] * Math.PI / 180;

    const Rvec = (1 - Math.cos(pR_rad)*Math.cos(rR_rad)) * 100;
    const Lvec = (1 - Math.cos(pL_rad)*Math.cos(rL_rad)) * 100;

    /* ===== 個別判定 ===== */
    const Rjudge=judge(Rvec,"R");
    const Ljudge=judge(Lvec,"L");

    /* ===== 最終推定（大きい方採用）===== */
    let result="N";
    if(Rvec>5 || Lvec>5){
      result = (Rvec>=Lvec)?Rjudge:Ljudge;
    }

    /* 表示更新 */
    guessDisplay.textContent="判定: "+result;

    /* Excel保存データ追加 */
    accelData.push([
      new Date().toLocaleTimeString(),
      latestRight[0],latestRight[1],Rvec.toFixed(2),Rjudge,
      latestLeft[0], latestLeft[1], Lvec.toFixed(2),Ljudge,
      declaration,
      result
    ]);
  });

  /* 接続表示更新 */
  document.getElementById("status"+id).textContent =
    `${id===1?"右":"左"}足 接続完了`;
}

/* ===== キャリブレーション ===== */
function calibrate(){
  baseRight=[...latestRight];
  baseLeft =[...latestLeft];
  alert("キャリブレーション完了");
}

/* ===== sleep関数 ===== */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ===== カウントダウン ===== */
async function countdown(sec){
  for(let i=sec;i>0;i--){
    countdownDisplay.textContent=i;
    await sleep(1000);
  }
  countdownDisplay.textContent="";
}

/* ===== 実験自動ループ ===== */
async function runRepeat(){
  for(let i=1;i<=10;i++){

    /* 通常姿勢（緑） */
    document.body.style.background="#eaf7f3";
    await countdown(5);

    /* 足組み（赤） */
    document.body.style.background="#ffcccc";
    await countdown(10);
  }

  document.body.style.background="#eaf7f3";
  countdownDisplay.textContent="完了";
}

/* ===== Excel保存 ===== */
function downloadExcel(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(accelData);
  XLSX.utils.book_append_sheet(wb,ws,"Data");
  XLSX.writeFile(wb,"foot_data.xlsx");
}
</script>

</body>
</html>
