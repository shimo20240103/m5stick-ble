<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>M5StickC 足組みデータ取得（実験用１）</title>
<style>
body { font-family: 'Arial', sans-serif; background:#eaf7f3; color:#004d40; text-align:center; margin:0; padding:0; transition: background 0.3s; }
h1 { background:#a7ffeb; margin:0; padding:18px 0; border-bottom-left-radius:14px; border-bottom-right-radius:14px; }
.controls { margin:12px 0; }
button { font-size:15px; padding:8px 16px; margin:6px; border-radius:8px; border:none; background:#26a69a; color:#fff; cursor:pointer;}
#status1,#status2 { margin-top:10px; font-weight:bold; font-size:18px; display:block; }
pre { display:inline-block; background:#b2dfdb; padding:8px 14px; border-radius:10px; margin-top:10px; }
#countdownDisplay { font-size: 120px; font-weight: bold; color: #0d0d0d; margin: 30px 0; }
#currentPhaseDisplay { font-size: 24px; font-weight:bold; margin-top:20px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<h1>M5StickC 足組みデータ取得（実験用）</h1>

<div class="controls">
  <button id="connectBtn1" onclick="connect(1)">右足 接続</button>
  <button id="connectBtn2" onclick="connect(2)">左足 接続</button>
  <button onclick="calibrate()">キャリブレーション</button>
  <button onclick="downloadExcel()">Excelダウンロード</button>
</div>

<div id="status1">右足: 未接続</div>
<pre id="values1">Pitch:0.00 Roll:0.00</pre>

<div id="status2">左足: 未接続</div>
<pre id="values2">Pitch:0.00 Roll:0.00</pre>

<div class="controls">
  <button onclick="runSequence('right','45')">右: N → 45 → rest</button>
  <button onclick="runSequence('right','90')">右: N → 90 → rest</button>
  <button onclick="runSequence('left','45')">左: N → 45 → rest</button>
  <button onclick="runSequence('left','90')">左: N → 90 → rest</button>
</div>

<div id="currentPhaseDisplay">現在のフェーズ: idle</div>
<div id="countdownDisplay"></div>

<div id="guessDisplay" style="font-size:48px;font-weight:bold;margin-top:20px;color:#d32f2f;">
  判定: -
</div>

<script>
/* UUID */
const serviceUUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const charUUID    = "beb5483e-36e1-4688-b7f5-ea073f74076a";

/* 最新値 */
let latestRight = [0,0];
let latestLeft  = [0,0];

/* キャリブレーション値 */
let baseRight = null;
let baseLeft  = null;

/* Excel */
let accelData = [[
  "Time",
  "Right_P","Right_R","Rvector",
  "Left_P","Left_R","Lvector",
  "Phase",
  "Guess"
]];

let currentPhase = "idle";

/* 判定 */
function judgeByVector(v){
  if(v > 70) return "90";
  if(v > 15) return "45";
  return "N";
}

/* BLE */
async function connect(id){
  const device = await navigator.bluetooth.requestDevice({
    acceptAllDevices:true,
    optionalServices:[serviceUUID]
  });
  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(serviceUUID);
  const char = await service.getCharacteristic(charUUID);
  await char.startNotifications();

  char.addEventListener("characteristicvaluechanged", e=>{
    const [p,r] = new TextDecoder().decode(e.target.value).trim().split(",").map(Number);
    if(isNaN(p)||isNaN(r)) return;

    if(id===1){
      latestRight=[p,r];
      document.getElementById("values1").textContent=`Pitch:${p.toFixed(2)} Roll:${r.toFixed(2)}`;
    }else{
      latestLeft=[p,r];
      document.getElementById("values2").textContent=`Pitch:${p.toFixed(2)} Roll:${r.toFixed(2)}`;
    }

    const dR = baseRight ? [
      latestRight[0]-baseRight[0],
      latestRight[1]-baseRight[1]
    ] : [0,0];

    const dL = baseLeft ? [
      latestLeft[0]-baseLeft[0],
      latestLeft[1]-baseLeft[1]
    ] : [0,0];

    const Rvec = Math.sqrt(dR[0]*dR[0]+dR[1]*dR[1]);
    const Lvec = Math.sqrt(dL[0]*dL[0]+dL[1]*dL[1]);

    let guess="";
    if(currentPhase.startsWith("R")) guess=judgeByVector(Rvec);
    if(currentPhase.startsWith("L")) guess=judgeByVector(Lvec);

    document.getElementById("guessDisplay").textContent="判定: "+(guess||"-");

    accelData.push([
      new Date().toLocaleTimeString(),
      latestRight[0],latestRight[1],Rvec.toFixed(2),
      latestLeft[0], latestLeft[1], Lvec.toFixed(2),
      currentPhase,
      guess
    ]);
  });

  document.getElementById("status"+id).textContent =
    `${id===1?"右":"左"}足 接続完了`;
}

/* キャリブレーション */
function calibrate(){
  baseRight = [...latestRight];
  baseLeft  = [...latestLeft];
  alert("キャリブレーション完了（Pitch / Roll を初期値として記憶）");
}

/* 以下 既存処理（変更なし） */
function playBeep(){/* 省略：元コードと同じ */}
function startCountdown(sec){/* 元コードと同じ */}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function runSequence(side,target){/* 元コードと同じ */}
function downloadExcel(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(accelData);
  XLSX.utils.book_append_sheet(wb,ws,"Data");
  XLSX.writeFile(wb,"foot_data.xlsx");
}
</script>
</body>
</html>
