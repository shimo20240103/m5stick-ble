<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>M5StickC 足組み判定（研究用・軽量版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
  font-family:Arial, sans-serif;
  background:#eaf7f3;
  color:#004d40;
  text-align:center;
  margin:0;
  padding:16px;
}
h1{
  background:#a7ffeb;
  padding:12px;
  border-radius:12px;
}
button{
  font-size:15px;
  padding:8px 14px;
  margin:6px;
  border:none;
  border-radius:8px;
  background:#26a69a;
  color:white;
  cursor:pointer;
}
.section{
  background:#ffffff;
  border-radius:14px;
  padding:14px;
  margin:14px auto;
  max-width:720px;
}
.phase{
  font-size:40px;
  font-weight:bold;
}
pre{
  text-align:left;
  background:#b2dfdb;
  padding:10px;
  border-radius:10px;
  max-height:220px;
  overflow:auto;
}
</style>
</head>

<body>

<h1>M5StickC 足組み判定（研究用・軽量版）</h1>

<div class="section">
  <button onclick="connect('R')">右足 接続</button>
  <button onclick="connect('L')">左足 接続</button>
  <button onclick="calibrate()">キャリブレーション</button>
  <button onclick="downloadExcel()">Excel保存</button>
</div>

<div class="section">
  <h2>現在の状態</h2>
  <div>右：<span id="phaseR" class="phase">—</span></div>
  <div>左：<span id="phaseL" class="phase">—</span></div>
</div>

<div class="section">
  <h2>ログ（直近10件）</h2>
  <pre id="log"></pre>
</div>

<script>
/* ===== UUID ===== */
const serviceUUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const charUUID    = "beb5483e-36e1-4688-b7f5-ea073f74076a";

/* ===== 状態 ===== */
let base = {
  R:{pitch:null, roll:null},
  L:{pitch:null, roll:null}
};

let last = {
  R:{pitch:null, roll:null},
  L:{pitch:null, roll:null}
};

let logData = [[
  "Time",
  "Side",
  "Pitch",
  "Roll",
  "ΔPitch",
  "ΔRoll",
  "Vector",
  "Phase"
]];

/* ===== 判定 ===== */
function judgeByVector(v){
  if(v >= 21 && v <= 50) return "45";
  if(v >= 51 && v <= 120) return "90";
  return "N";
}

/* ===== BLE 接続 ===== */
async function connect(side){
  const device = await navigator.bluetooth.requestDevice({
    acceptAllDevices:true,
    optionalServices:[serviceUUID]
  });
  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(serviceUUID);
  const char = await service.getCharacteristic(charUUID);

  await char.startNotifications();
  char.addEventListener("characteristicvaluechanged", e=>{
    const txt = new TextDecoder().decode(e.target.value).trim();
    const [p,r] = txt.split(",").map(Number);
    if(!isNaN(p) && !isNaN(r)) update(side, p, r);
  });
}

/* ===== 更新処理 ===== */
function update(side, pitch, roll){
  last[side].pitch = pitch;
  last[side].roll  = roll;

  if(base[side].pitch === null) return; // 未キャリブレーション

  const dp = pitch - base[side].pitch;
  const dr = roll  - base[side].roll;

  const vector = Math.sqrt(dp*dp + dr*dr);
  const phase  = judgeByVector(vector);

  document.getElementById("phase"+side).textContent = phase;

  const t = new Date().toLocaleTimeString();
  logData.push([
    t,
    side,
    pitch.toFixed(1),
    roll.toFixed(1),
    dp.toFixed(1),
    dr.toFixed(1),
    vector.toFixed(1),
    phase
  ]);

  document.getElementById("log").textContent =
    logData.slice(-10)
      .map(r=>`${r[0]} ${r[1]} V=${r[6]} → ${r[7]}`)
      .join("\n");
}

/* ===== キャリブレーション ===== */
function calibrate(){
  if(last.R.pitch !== null){
    base.R.pitch = last.R.pitch;
    base.R.roll  = last.R.roll;
  }
  if(last.L.pitch !== null){
    base.L.pitch = last.L.pitch;
    base.L.roll  = last.L.roll;
  }
  alert("キャリブレーション完了（Pitch / Roll 記憶）");
}

/* ===== Excel ===== */
function downloadExcel(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(logData);
  XLSX.utils.book_append_sheet(wb, ws, "LegJudge");
  XLSX.writeFile(wb,"leg_judge_log.xlsx");
}
</script>

</body>
</html>
