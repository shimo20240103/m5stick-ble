<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>足組み判定（キャリブレーション対応）</title>
<style>
  body { font-family: Arial; padding: 20px; }
  #status { font-size: 28px; font-weight: bold; margin-top: 20px; }
</style>
</head>

<body>

<h2>足組み判定システム</h2>

<button id="startCalib">キャリブレーション開始（10秒）</button>

<p>初期ピッチ：<span id="pitchBaseDisp">-</span></p>
<p>初期ロール：<span id="rollBaseDisp">-</span></p>

<h3>現在の状態：<span id="status">未計測</span></h3>


<script>

// -------------------------
// グローバル変数
// -------------------------
let pitchBase = 0;
let rollBase  = 0;

let pitchThreshold45 = 0;
let pitchThreshold90 = 0;

let rollThreshold45 = 0;
let rollThreshold90 = 0;

let calibDataPitch = [];
let calibDataRoll = [];


// -------------------------
// ① キャリブレーション開始
// -------------------------
document.getElementById("startCalib").addEventListener("click", () => {
    calibDataPitch = [];
    calibDataRoll = [];

    let seconds = 10;
    document.getElementById("status").innerText = `キャリブレーション中…（${seconds}s）`;

    let timer = setInterval(() => {
        seconds--;
        document.getElementById("status").innerText = `キャリブレーション中…（残り${seconds}s）`;

        if (seconds <= 0) {
            clearInterval(timer);
            finishCalibration();
        }
    }, 1000);
});


// -------------------------
// ② 10秒後に平均を初期値に設定
// -------------------------
function finishCalibration() {
    pitchBase = average(calibDataPitch);
    rollBase  = average(calibDataRoll);

    // 閾値更新
    updateThresholds();

    document.getElementById("pitchBaseDisp").innerText = pitchBase.toFixed(2);
    document.getElementById("rollBaseDisp").innerText  = rollBase.toFixed(2);
    document.getElementById("status").innerText = "キャリブレーション完了！";
}


// -------------------------
// ③ 閾値設定
// -------------------------
function updateThresholds() {
    pitchThreshold45 = pitchBase - 25;
    pitchThreshold90 = pitchBase - 70;

    rollThreshold45 = rollBase - 20;
    rollThreshold90 = rollBase - 95;
}


// -------------------------
// ④ 足組み判定
// -------------------------
function detectCrossLeg(pitch, roll) {
    let crossed45 = false;
    let crossed90 = false;

    // 45度組み：ピッチ AND ロール
    if (pitch <= pitchThreshold45 && roll <= rollThreshold45) {
        crossed45 = true;
    }

    // 90度組み：ピッチ AND ロール
    if (pitch <= pitchThreshold90 && roll <= rollThreshold90) {
        crossed90 = true;
    }

    // 優先：90 → 45 → なし
    if (crossed90) {
        return "90度組み";
    } else if (crossed45) {
        return "45度組み";
    } else {
        return "組んでいない";
    }
}


// -------------------------
// ⑤ 平均を計算
// -------------------------
function average(arr) {
    if (arr.length === 0) return 0;
    return arr.reduce((a, b) => a + b, 0) / arr.length;
}


// -------------------------
// ★ センサー値が来た時に呼ぶ部分
//    （ここだけBLE側に合わせて変更する）
// -------------------------
function onSensorReceived(pitch, roll) {

    // キャリブレーション中は保存だけ
    if (calibDataPitch.length < 2000) {  
        // 10秒で 2000 回くらい来る想定（1ms 更新の場合）
        calibDataPitch.push(pitch);
        calibDataRoll.push(roll);
    }

    // 判定
    const result = detectCrossLeg(pitch, roll);
    document.getElementById("status").innerText = result;
}


// -------------------------
// ★ デモ用：ランダム値で動作確認したい場合
//    （BLEがまだならこれで動作テストできます）
// -------------------------
setInterval(() => {
    const testPitch = pitchBase + (Math.random() * 40 - 20);
    const testRoll  = rollBase  + (Math.random() * 40 - 20);
    onSensorReceived(testPitch, testRoll);
}, 200);

</script>

</body>
</html>
