<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>M5StickC 足組み判定</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f4f4f4;
      text-align: center;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    button {
      padding: 12px 24px;
      margin: 10px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .data {
      font-size: 20px;
      margin-top: 20px;
    }
    .status {
      margin-top: 20px;
      font-size: 28px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>M5StickC 足組み判定ビューア</h1>
  <button id="connect">BLE接続</button>

  <div class="data">
    <div>X: <span id="x">---</span></div>
    <div>Y: <span id="y">---</span></div>
    <div>Z: <span id="z">---</span></div>
  </div>

  <div class="status" id="status">未接続</div>

  <script>
    const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const CHARACTERISTIC_UUID = "beb5483e-36e1-4688-b7f5-ea073f74076a";

    let characteristic;

    document.getElementById("connect").addEventListener("click", async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: "M5StickCPlus1.1" }],
          optionalServices: [SERVICE_UUID]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

        await characteristic.startNotifications();
        characteristic.addEventListener("characteristicvaluechanged", handleData);

        document.getElementById("status").innerText = "接続中...";
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "接続失敗";
      }
    });

    function handleData(event) {
      const value = new TextDecoder().decode(event.target.value);
      const [ax, ay, az] = value.split(",").map(parseFloat);

      document.getElementById("x").innerText = ax.toFixed(2);
      document.getElementById("y").innerText = ay.toFixed(2);
      document.getElementById("z").innerText = az.toFixed(2);

      // ======== 足組み判定（しきい値は自由に調整） ========
      const thresholdX = 100; // X軸のしきい値（例）
      const thresholdY = 120; // Y軸のしきい値（例）
      const thresholdZ = 150; // Z軸のしきい値（例）

      const isCrossed = Math.abs(ax) > thresholdX || Math.abs(ay) > thresholdY || Math.abs(az) > thresholdZ;
      document.getElementById("status").innerText = isCrossed ? "⚠️ 足組み中" : "✅ 正常姿勢";
      document.getElementById("status").style.color = isCrossed ? "red" : "green";
    }
  </script>
</body>
</html>
