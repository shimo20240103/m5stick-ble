<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>M5StickC 足組み判定（Sita1）</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#eaf7f3;
  color:#004d40;
  text-align:center;
  margin:0;
}
h1{
  background:#a7ffeb;
  padding:18px 0;
  margin:0;
}
button{
  font-size:15px;
  padding:8px 16px;
  margin:6px;
  border-radius:8px;
  border:none;
  background:#26a69a;
  color:white;
  cursor:pointer;
}
#status{
  margin-top:10px;
  font-weight:bold;
}
#sitaDisplay{
  font-size:48px;
  font-weight:bold;
  margin-top:20px;
}
#judgeDisplay{
  font-size:32px;
  font-weight:bold;
  margin-top:10px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body>

<h1>M5StickC 足組み判定（Sita1）</h1>

<button onclick="connect()">BLE 接続</button>
<button onclick="downloadExcel()">Excel保存</button>

<div id="status">未接続</div>
<div id="sitaDisplay">Sita: 0.0</div>
<div id="judgeDisplay">判定: 通常座位</div>

<script>
/* ===== UUID ===== */
const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_UUID    = "beb5483e-36e1-4688-b7f5-ea073f74076a";

/* ===== 閾値 ===== */
const THRESHOLD = 29.25;

/* ===== Excel ===== */
let logData=[[
  "Time",
  "Sita1",
  "ArduinoJudge",
  "HTMLJudge"
]];

/* ===== BLE ===== */
async function connect(){
  const device = await navigator.bluetooth.requestDevice({
    acceptAllDevices:true,
    optionalServices:[SERVICE_UUID]
  });

  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(SERVICE_UUID);
  const char = await service.getCharacteristic(CHAR_UUID);

  await char.startNotifications();
  status.textContent = "接続中";

  char.addEventListener("characteristicvaluechanged", e=>{
    const text = new TextDecoder().decode(e.target.value).trim();

    // 期待形式: sita1,flag
    const parts = text.split(",");
    if(parts.length < 1) return;

    const sita1 = parseFloat(parts[0]);
    const arduinoJudge = parts[1] ? Number(parts[1]) : 0;

    if(isNaN(sita1)) return;

    sitaDisplay.textContent = `Sita: ${sita1.toFixed(1)}`;

    /* ===== HTML側判定 ===== */
    const htmlJudge = sita1 > THRESHOLD ? 1 : 0;

    judgeDisplay.textContent =
      "判定: " + (htmlJudge ? "足組み" : "通常座位");

    document.body.style.background =
      htmlJudge ? "#ffcccc" : "#eaf7f3";

    logData.push([
      new Date().toLocaleTimeString(),
      sita1.toFixed(1),
      arduinoJudge,
      htmlJudge
    ]);
  });
}

/* ===== Excel ===== */
function downloadExcel(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(logData);
  XLSX.utils.book_append_sheet(wb, ws, "SitaData");
  XLSX.writeFile(wb, "sita1_posture.xlsx");
}
</script>

</body>
</html>
